/* 
 * This file is part of Stack Wallet.
 * 
 * Copyright (c) 2023 Cypher Stack
 * All Rights Reserved.
 * The code is distributed under GPLv3 license, see LICENSE file for details.
 * Generated by Cypher Stack on 2023-05-26
 *
 */

import 'dart:async';

import 'package:decimal/decimal.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../app_config.dart';
import '../../../models/exchange/incomplete_exchange.dart';
import '../../../models/exchange/response_objects/trade.dart';
import '../../../pages/exchange_view/send_from_view.dart';
import '../../../providers/exchange/exchange_form_state_provider.dart';
import '../../../providers/global/trades_service_provider.dart';
import '../../../route_generator.dart';
import '../../../services/exchange/exchange_response.dart';
import '../../../services/notifications_api.dart';
import '../../../themes/stack_colors.dart';
import '../../../utilities/amount/amount.dart';
import '../../../utilities/assets.dart';
import '../../../utilities/enums/exchange_rate_type_enum.dart';
import '../../../utilities/text_styles.dart';
import '../../../widgets/custom_buttons/app_bar_icon_button.dart';
import '../../../widgets/custom_loading_overlay.dart';
import '../../../widgets/desktop/desktop_dialog.dart';
import '../../../widgets/desktop/desktop_dialog_close_button.dart';
import '../../../widgets/desktop/primary_button.dart';
import '../../../widgets/desktop/secondary_button.dart';
import '../../../widgets/desktop/simple_desktop_dialog.dart';
import '../../../widgets/fade_stack.dart';
import '../../../widgets/qr.dart';
import '../subwidgets/desktop_exchange_steps_indicator.dart';
import 'subwidgets/desktop_step_1.dart';
import 'subwidgets/desktop_step_2.dart';
import 'subwidgets/desktop_step_3.dart';
import 'subwidgets/desktop_step_4.dart';

final ssss = StateProvider<IncompleteExchangeModel?>((_) => null);

final desktopExchangeModelProvider =
    ChangeNotifierProvider<IncompleteExchangeModel?>(
  (ref) => ref.watch(ssss.state).state,
);

class StepScaffold extends ConsumerStatefulWidget {
  const StepScaffold({
    super.key,
    required this.initialStep,
  });

  final int initialStep;

  @override
  ConsumerState<StepScaffold> createState() => _StepScaffoldState();
}

class _StepScaffoldState extends ConsumerState<StepScaffold> {
  int currentStep = 1;
  bool enableNext = false;

  late final Duration duration;

  void updateEnableNext(bool enableNext) {
    if (enableNext != this.enableNext) {
      setState(() => this.enableNext = enableNext);
    }
  }

  Future<bool> createTrade() async {
    unawaited(
      showDialog<void>(
        context: context,
        barrierDismissible: false,
        builder: (_) => WillPopScope(
          onWillPop: () async => false,
          child: Container(
            color: Theme.of(context)
                .extension<StackColors>()!
                .overlay
                .withOpacity(0.6),
            child: const CustomLoadingOverlay(
              message: "Creating a trade",
              eventBus: null,
            ),
          ),
        ),
      ),
    );

    final ExchangeResponse<Trade> response = await ref
        .read(efExchangeProvider)
        .createTrade(
          from: ref.read(desktopExchangeModelProvider)!.sendTicker,
          to: ref.read(desktopExchangeModelProvider)!.receiveTicker,
          fixedRate: ref.read(desktopExchangeModelProvider)!.rateType !=
              ExchangeRateType.estimated,
          amount: ref.read(desktopExchangeModelProvider)!.reversed
              ? ref.read(desktopExchangeModelProvider)!.receiveAmount
              : ref.read(desktopExchangeModelProvider)!.sendAmount,
          addressTo: ref.read(desktopExchangeModelProvider)!.recipientAddress!,
          extraId: null,
          addressRefund: ref.read(desktopExchangeModelProvider)!.refundAddress!,
          refundExtraId: "",
          estimate: ref.read(desktopExchangeModelProvider)!.estimate,
          reversed: ref.read(desktopExchangeModelProvider)!.reversed,
        );

    if (response.value == null) {
      if (mounted) {
        Navigator.of(context).pop();

        String? message;
        if (response.exception != null) {
          message = response.exception!.toString();
          // TODO: better errors
          if (message.startsWith("FormatException:") &&
              message.contains("<html>")) {
            message = "${ref.read(efExchangeProvider).name} server error";
          }
        }

        unawaited(
          showDialog<void>(
            context: context,
            barrierDismissible: true,
            builder: (_) => SimpleDesktopDialog(
              title: "Failed to create trade",
              message: message ?? "",
            ),
          ),
        );
      }
      return false;
    }

    // save trade to hive
    await ref.read(tradesServiceProvider).add(
          trade: response.value!,
          shouldNotifyListeners: true,
        );

    String status = response.value!.status;

    ref.read(desktopExchangeModelProvider)!.trade = response.value!;

    // extra info if status is waiting
    if (status == "Waiting") {
      status += " for deposit";
    }

    if (mounted) {
      Navigator.of(context).pop();
    }

    unawaited(
      NotificationApi.showNotification(
        changeNowId: ref.read(desktopExchangeModelProvider)!.trade!.tradeId,
        title: status,
        body:
            "Trade ID ${ref.read(desktopExchangeModelProvider)!.trade!.tradeId}",
        walletId: "",
        iconAssetName: Assets.svg.arrowRotate,
        date: ref.read(desktopExchangeModelProvider)!.trade!.timestamp,
        shouldWatchForUpdates: true,
        coinName: "coinName",
      ),
    );

    return true;
    // if (mounted) {
    //   unawaited(
    //     showDialog<void>(
    //       context: context,
    //       barrierColor: Colors.transparent,
    //       barrierDismissible: false,
    //       builder: (context) {
    //         return DesktopDialog(
    //           maxWidth: 720,
    //           maxHeight: double.infinity,
    //           child: StepScaffold(
    //             initialStep: 4,
    //           ),
    //         );
    //       },
    //     ),
    //   );
    // }
  }

  void onBack() {
    if (currentStep > 1 && currentStep < 4) {
      setState(() => currentStep = currentStep - 1);
    } else if (currentStep == 1) {
      Navigator.of(context, rootNavigator: true).pop();
    }
  }

  void sendFromStack() {
    final trade = ref.read(desktopExchangeModelProvider)!.trade!;
    final address = trade.payInAddress;
    final coin = AppConfig.getCryptoCurrencyForTicker(trade.payInCurrency) ??
        AppConfig.getCryptoCurrencyByPrettyName(trade.payInCurrency);
    final amount = Decimal.parse(trade.payInAmount).toAmount(
      fractionDigits: coin.fractionDigits,
    );

    showDialog<void>(
      context: context,
      builder: (context) => Navigator(
        initialRoute: SendFromView.routeName,
        onGenerateRoute: RouteGenerator.generateRoute,
        onGenerateInitialRoutes: (_, __) {
          return [
            FadePageRoute(
              SendFromView(
                coin: coin,
                trade: trade,
                amount: amount,
                address: address,
                shouldPopRoot: true,
                fromDesktopStep4: true,
              ),
              const RouteSettings(
                name: SendFromView.routeName,
              ),
            ),
          ];
        },
      ),
    );
  }

  @override
  void initState() {
    duration = const Duration(milliseconds: 250);
    currentStep = widget.initialStep;
    super.initState();
  }

  @override
  Widget build(BuildContext context) {
    final model = ref.watch(desktopExchangeModelProvider);
    return Column(
      mainAxisAlignment: MainAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Row(
              children: [
                currentStep != 4
                    ? AppBarBackButton(
                        isCompact: true,
                        iconSize: 23,
                        onPressed: onBack,
                      )
                    : const SizedBox(
                        width: 32,
                      ),
                Text(
                  "Exchange ${model?.sendTicker.toUpperCase()} to ${model?.receiveTicker.toUpperCase()}",
                  style: STextStyles.desktopH3(context),
                ),
              ],
            ),
            if (currentStep == 4)
              DesktopDialogCloseButton(
                onPressedOverride: () {
                  Navigator.of(context, rootNavigator: true).pop();
                },
              ),
          ],
        ),
        const SizedBox(
          height: 12,
        ),
        Padding(
          padding: const EdgeInsets.symmetric(
            horizontal: 32,
          ),
          child: DesktopExchangeStepsIndicator(
            currentStep: currentStep,
          ),
        ),
        const SizedBox(
          height: 32,
        ),
        Padding(
          padding: const EdgeInsets.symmetric(
            horizontal: 32,
          ),
          child: FadeStack(
            index: currentStep - 1,
            children: [
              const DesktopStep1(),
              DesktopStep2(
                enableNextChanged: updateEnableNext,
              ),
              const DesktopStep3(),
              const DesktopStep4(),
            ],
          ),
        ),
        Padding(
          padding: const EdgeInsets.only(
            top: 20,
            left: 32,
            right: 32,
            bottom: 32,
          ),
          child: Row(
            children: [
              Expanded(
                child: AnimatedCrossFade(
                  duration: const Duration(milliseconds: 250),
                  crossFadeState: currentStep == 4
                      ? CrossFadeState.showSecond
                      : CrossFadeState.showFirst,
                  firstChild: SecondaryButton(
                    label: "Back",
                    buttonHeight: ButtonHeight.l,
                    onPressed: onBack,
                  ),
                  secondChild: SecondaryButton(
                    label: "Send from ${AppConfig.appName}",
                    buttonHeight: ButtonHeight.l,
                    onPressed: sendFromStack,
                  ),
                ),
              ),
              const SizedBox(
                width: 16,
              ),
              Expanded(
                child: AnimatedCrossFade(
                  duration: const Duration(milliseconds: 250),
                  crossFadeState: currentStep == 4
                      ? CrossFadeState.showSecond
                      : CrossFadeState.showFirst,
                  firstChild: AnimatedCrossFade(
                    duration: const Duration(milliseconds: 250),
                    crossFadeState: currentStep == 3
                        ? CrossFadeState.showSecond
                        : CrossFadeState.showFirst,
                    firstChild: PrimaryButton(
                      label: "Next",
                      enabled: currentStep != 2 ? true : enableNext,
                      buttonHeight: ButtonHeight.l,
                      onPressed: () async {
                        setState(() => currentStep = currentStep + 1);
                      },
                    ),
                    secondChild: PrimaryButton(
                      label: "Confirm",
                      enabled: currentStep != 2 ? true : enableNext,
                      buttonHeight: ButtonHeight.l,
                      onPressed: () async {
                        if (currentStep == 3) {
                          final success = await createTrade();
                          if (!success) {
                            return;
                          }
                        }
                        setState(() => currentStep = currentStep + 1);
                      },
                    ),
                  ),
                  secondChild: PrimaryButton(
                    label: "Show QR code",
                    enabled: currentStep != 2 ? true : enableNext,
                    buttonHeight: ButtonHeight.l,
                    onPressed: () {
                      showDialog<dynamic>(
                        context: context,
                        barrierColor: Colors.transparent,
                        barrierDismissible: true,
                        builder: (_) {
                          return DesktopDialog(
                            maxHeight: 720,
                            maxWidth: 720,
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              crossAxisAlignment: CrossAxisAlignment.center,
                              children: [
                                Text(
                                  "Send ${ref.watch(desktopExchangeModelProvider.select((value) => value!.sendAmount.toStringAsFixed(8)))} ${ref.watch(desktopExchangeModelProvider.select((value) => value!.sendTicker))} to this address",
                                  style: STextStyles.desktopH3(context),
                                ),
                                const SizedBox(
                                  height: 48,
                                ),
                                Center(
                                  child: QR(
                                    // TODO: grab coin uri scheme from somewhere
                                    // data: "${coin.uriScheme}:$receivingAddress",
                                    data: ref.watch(
                                      desktopExchangeModelProvider.select(
                                        (value) => value!.trade!.payInAddress,
                                      ),
                                    ),
                                    size: 290,
                                  ),
                                ),
                                const SizedBox(
                                  height: 48,
                                ),
                                SecondaryButton(
                                  label: "Cancel",
                                  width: 310,
                                  buttonHeight: ButtonHeight.l,
                                  onPressed: Navigator.of(context).pop,
                                ),
                              ],
                            ),
                          );
                        },
                      );
                    },
                  ),
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }
}

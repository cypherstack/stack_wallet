/* 
 * This file is part of Stack Wallet.
 * 
 * Copyright (c) 2023 Cypher Stack
 * All Rights Reserved.
 * The code is distributed under GPLv3 license, see LICENSE file for details.
 * Generated by Cypher Stack on 2023-05-26
 *
 */

import 'dart:io';

import 'package:local_auth/local_auth.dart';
import 'package:local_auth_android/local_auth_android.dart';

import 'logger.dart';

class Biometrics {
  static const integrationTestFlag =
      bool.fromEnvironment("IS_INTEGRATION_TEST");

  const Biometrics();

  Future<bool> authenticate({
    required String cancelButtonText,
    required String localizedReason,
    required String title,
  }) async {
    if (!(Platform.isIOS || Platform.isAndroid)) {
      Logging.instance.w(
        "Tried to use Biometrics.authenticate() on a platform that is not Android or iOS! ...returning false.",
      );
      return false;
    }
    if (integrationTestFlag) {
      Logging.instance.w(
        "Tried to use Biometrics.authenticate() during integration testing. Returning false.",
      );
      return false;
    }

    final LocalAuthentication localAuth = LocalAuthentication();

    final canCheckBiometrics = await localAuth.canCheckBiometrics;
    final isDeviceSupported = await localAuth.isDeviceSupported();

    // debugPrint("canCheckBiometrics: $canCheckBiometrics");
    // debugPrint("isDeviceSupported: $isDeviceSupported");

    if (canCheckBiometrics && isDeviceSupported) {
      final List<BiometricType> availableSystems =
          await localAuth.getAvailableBiometrics();

      Logging.instance.w(
        "Bio availableSystems: $availableSystems",
        stackTrace: StackTrace.current,
      );

      //TODO properly handle caught exceptions
      try {
        final bool didAuthenticate = await localAuth.authenticate(
          localizedReason: localizedReason,
          options: const AuthenticationOptions(
            stickyAuth: true,
            biometricOnly: true,
          ),
          authMessages: <AuthMessages>[
            AndroidAuthMessages(
              biometricHint: "",
              cancelButton: cancelButtonText,
              signInTitle: title,
            ),
          ],
        );

        if (didAuthenticate) {
          return true;
        }
      } catch (e, s) {
        Logging.instance.e(
          "local_auth exception caught in Biometrics.authenticate(), e: $e",
          error: e,
          stackTrace: s,
        );
      }
    }

    // authentication failed
    return false;
  }
}

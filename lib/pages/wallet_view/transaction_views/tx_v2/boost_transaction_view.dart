/* 
 * This file is part of Stack Wallet.
 * 
 * Copyright (c) 2023 Cypher Stack
 * All Rights Reserved.
 * The code is distributed under GPLv3 license, see LICENSE file for details.
 * Generated by Cypher Stack on 2023-05-26
 *
 */

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../../models/isar/models/blockchain_data/v2/transaction_v2.dart';
import '../../../../themes/stack_colors.dart';
import '../../../../utilities/amount/amount.dart';
import '../../../../utilities/amount/amount_formatter.dart';
import '../../../../utilities/text_styles.dart';
import '../../../../utilities/util.dart';
import '../../../../wallets/isar/providers/wallet_info_provider.dart';
import '../../../../widgets/background.dart';
import '../../../../widgets/boost_fee_slider.dart';
import '../../../../widgets/conditional_parent.dart';
import '../../../../widgets/custom_buttons/app_bar_icon_button.dart';
import '../../../../widgets/desktop/primary_button.dart';
import '../../../../widgets/detail_item.dart';
import '../../../../widgets/rounded_white_container.dart';

class BoostTransactionView extends ConsumerStatefulWidget {
  const BoostTransactionView({
    super.key,
    required this.transaction,
  });

  static const String routeName = "/boostTransaction";

  final TransactionV2 transaction;

  @override
  ConsumerState<BoostTransactionView> createState() =>
      _BoostTransactionViewState();
}

class _BoostTransactionViewState extends ConsumerState<BoostTransactionView> {
  late final bool isDesktop;
  late final String walletId;
  late final TransactionV2 _transaction;
  late final Amount fee;
  late final Amount amount;

  BigInt? customFee;

  bool _previewTxnLock = false;
  Future<void> _previewTxn() async {
    if (_previewTxnLock) {
      return;
    }
    _previewTxnLock = true;
    try {
      // TODO [prio=high]: define previewSend
      // build new tx and show loading/tx generation

      // on success show confirm tx screen

      // on failure show error message
    } finally {
      _previewTxnLock = false;
    }
  }

  @override
  void initState() {
    isDesktop = Util.isDesktop;
    _transaction = widget.transaction;
    walletId = _transaction.walletId;
    fee = _transaction.getFee(
      fractionDigits: ref.read(pWalletCoin(walletId)).fractionDigits,
    );
    amount = _transaction.getAmountSentFromThisWallet(
      fractionDigits: ref.read(pWalletCoin(walletId)).fractionDigits,
    );

    super.initState();
  }

  @override
  Widget build(BuildContext context) {
    final coin = ref.watch(pWalletCoin(walletId));
    final String feeString = ref.watch(pAmountFormatter(coin)).format(
          fee,
        );
    final String amountString = ref.watch(pAmountFormatter(coin)).format(
          amount,
        );
    final String feeRateString =
        "${(fee.raw / BigInt.from(_transaction.vSize!)).toStringAsFixed(1)}"
        " sats/vByte";

    return ConditionalParent(
      condition: !isDesktop,
      builder: (child) => Background(
        child: Scaffold(
          backgroundColor:
              Theme.of(context).extension<StackColors>()!.background,
          appBar: AppBar(
            backgroundColor:
                Theme.of(context).extension<StackColors>()!.background,
            leading: AppBarBackButton(
              onPressed: () async {
                Navigator.of(context).pop();
              },
            ),
            title: Text(
              "Boost transaction",
              style: STextStyles.navBarTitle(context),
            ),
          ),
          body: child,
        ),
      ),
      child: Padding(
        padding: isDesktop
            ? const EdgeInsets.only(
                left: 32,
                right: 32,
                bottom: 32,
              )
            : const EdgeInsets.all(12),
        child: ConditionalParent(
          condition: isDesktop,
          builder: (child) {
            return Column(
              children: [
                RoundedWhiteContainer(
                  borderColor: isDesktop
                      ? Theme.of(context)
                          .extension<StackColors>()!
                          .backgroundAppBar
                      : null,
                  padding: const EdgeInsets.all(0),
                  child: child,
                ),
                const SizedBox(
                  height: 32,
                ),
                PrimaryButton(
                  buttonHeight: ButtonHeight.l,
                  label: "Preview send",
                  onPressed: _previewTxn,
                ),
              ],
            );
          },
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              RoundedWhiteContainer(
                padding: isDesktop
                    ? const EdgeInsets.all(0)
                    : const EdgeInsets.all(12),
                child: Column(
                  children: [
                    DetailItem(
                      title: "Send amount",
                      detail: amountString,
                      horizontal: true,
                    ),
                    const _Divider(),
                    DetailItem(
                      title: "Current fee",
                      detail: feeString,
                      horizontal: true,
                    ),
                    const _Divider(),
                    DetailItem(
                      title: "Current fee rate",
                      detail: feeRateString,
                      horizontal: true,
                    ),
                    const _Divider(),
                    Padding(
                      padding: const EdgeInsets.all(10),
                      child: BoostFeeSlider(
                        coin: coin,
                        onFeeChanged: (fee) {
                          customFee = fee;
                        },
                        min: _transaction
                            .getFee(fractionDigits: coin.fractionDigits)
                            .raw,
                        max: _transaction
                                .getFee(fractionDigits: coin.fractionDigits)
                                .raw *
                            BigInt.from(4),
                        // TODO [prio=med]: The max fee should be set to an absurd fee.
                      ),
                    ),
                  ],
                ),
              ),
              if (!isDesktop)
                const SizedBox(
                  height: 20,
                ),
              if (!isDesktop)
                PrimaryButton(
                  buttonHeight: ButtonHeight.l,
                  label: "Preview send",
                  onPressed: _previewTxn,
                ),
            ],
          ),
        ),
      ),
    );
  }
}

class _Divider extends StatelessWidget {
  const _Divider({super.key});

  @override
  Widget build(BuildContext context) {
    if (Util.isDesktop) {
      return Container(
        height: 1,
        color: Theme.of(context).extension<StackColors>()!.backgroundAppBar,
      );
    } else {
      return const SizedBox(
        height: 12,
      );
    }
  }
}

/* 
 * This file is part of Stack Wallet.
 * 
 * Copyright (c) 2023 Cypher Stack
 * All Rights Reserved.
 * The code is distributed under GPLv3 license, see LICENSE file for details.
 * Generated by Cypher Stack on 2023-05-26
 *
 */

import 'dart:async';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../../models/keys/view_only_wallet_data.dart';
import '../../../../providers/providers.dart';
import '../../../../route_generator.dart';
import '../../../../themes/stack_colors.dart';
import '../../../../utilities/constants.dart';
import '../../../../utilities/logger.dart';
import '../../../../utilities/text_styles.dart';
import '../../../../wallets/isar/models/wallet_info.dart';
import '../../../../wallets/isar/providers/wallet_info_provider.dart';
import '../../../../wallets/wallet/intermediate/lib_monero_wallet.dart';
import '../../../../wallets/wallet/intermediate/lib_salvium_wallet.dart';
import '../../../../wallets/wallet/wallet_mixin_interfaces/multi_address_interface.dart';
import '../../../../wallets/wallet/wallet_mixin_interfaces/mweb_interface.dart';
import '../../../../wallets/wallet/wallet_mixin_interfaces/rbf_interface.dart';
import '../../../../wallets/wallet/wallet_mixin_interfaces/spark_interface.dart';
import '../../../../wallets/wallet/wallet_mixin_interfaces/view_only_option_interface.dart';
import '../../../../widgets/background.dart';
import '../../../../widgets/custom_buttons/app_bar_icon_button.dart';
import '../../../../widgets/custom_buttons/draggable_switch_button.dart';
import '../../../../widgets/desktop/primary_button.dart';
import '../../../../widgets/desktop/secondary_button.dart';
import '../../../../widgets/rounded_white_container.dart';
import '../../../../widgets/stack_dialog.dart';
import '../../../pinpad_views/lock_screen_view.dart';
import 'delete_wallet_warning_view.dart';
import 'edit_refresh_height_view.dart';
import 'rbf_settings_view.dart';
import 'rename_wallet_view.dart';
import 'spark_info.dart';

class WalletSettingsWalletSettingsView extends ConsumerStatefulWidget {
  const WalletSettingsWalletSettingsView({super.key, required this.walletId});

  static const String routeName = "/walletSettingsWalletSettings";

  final String walletId;

  @override
  ConsumerState<WalletSettingsWalletSettingsView> createState() =>
      _WalletSettingsWalletSettingsViewState();
}

class _WalletSettingsWalletSettingsViewState
    extends ConsumerState<WalletSettingsWalletSettingsView> {
  late final DSBController _switchController;
  late final DSBController _switchControllerMwebToggle;

  bool _switchDuressToggleLock = false; // Mutex.
  Future<void> _switchDuressToggled() async {
    if (_switchDuressToggleLock) {
      return;
    }
    _switchDuressToggleLock = true; // Lock mutex.

    try {
      final visibility = ref.read(pWalletInfo(widget.walletId)).isDuressVisible;

      await ref
          .read(pWalletInfo(widget.walletId))
          .updateDuressVisibilityStatus(
            isDuressVisible: !visibility,
            isar: ref.read(mainDBProvider).isar,
          );
    } catch (e, s) {
      Logging.instance.f(
        "Failed to update duress visibility for wallet",
        error: e,
        stackTrace: s,
      );
    } finally {
      // ensure _switchDuressToggleLock is set to false no matter what.
      _switchDuressToggleLock = false;
    }
  }

  bool _switchReuseAddressToggledLock = false; // Mutex.
  Future<void> _switchReuseAddressToggled() async {
    if (_switchReuseAddressToggledLock) {
      return;
    }
    _switchReuseAddressToggledLock = true; // Lock mutex.

    try {
      if (_switchController.isOn?.call() != true) {
        final canContinue = await showDialog<bool?>(
          context: context,
          builder: (context) {
            return StackDialog(
              title: "Warning!",
              message:
                  "Reusing addresses reduces your privacy and security.  Are you sure you want to reuse addresses by default?",
              leftButton: TextButton(
                style: Theme.of(context)
                    .extension<StackColors>()!
                    .getSecondaryEnabledButtonStyle(context),
                child: Text(
                  "Cancel",
                  style: STextStyles.itemSubtitle12(context),
                ),
                onPressed: () {
                  Navigator.of(context).pop(false);
                },
              ),
              rightButton: TextButton(
                style: Theme.of(context)
                    .extension<StackColors>()!
                    .getPrimaryEnabledButtonStyle(context),
                child: Text("Continue", style: STextStyles.button(context)),
                onPressed: () {
                  Navigator.of(context).pop(true);
                },
              ),
            );
          },
        );

        if (canContinue == true) {
          await _updateAddressReuse(true);
        }
      } else {
        await _updateAddressReuse(false);
      }
    } finally {
      // ensure _switchReuseAddressToggledLock is set to false no matter what.
      _switchReuseAddressToggledLock = false;
    }
  }

  bool _switchMwebToggleToggledLock = false; // Mutex.
  Future<void> _switchMwebToggleToggled() async {
    if (_switchMwebToggleToggledLock) {
      return;
    }
    _switchMwebToggleToggledLock = true; // Lock mutex.

    try {
      if (_switchControllerMwebToggle.isOn?.call() != true) {
        final canContinue = await showDialog<bool?>(
          context: context,
          builder: (context) {
            return StackDialog(
              title: "Notice",
              message:
                  "Activating MWEB requires some synchronization with the p2p network. "
                  "This process currently takes around 30 minutes to complete, "
                  "as it involves synchronizing on-chain MWEB related data.",
              leftButton: SecondaryButton(
                onPressed: () {
                  Navigator.of(context).pop(false);
                },
                label: "Cancel",
              ),
              rightButton: PrimaryButton(
                onPressed: () {
                  Navigator.of(context).pop(true);
                },
                label: "Continue",
              ),
            );
          },
        );

        if (canContinue == true) {
          await _updateMwebToggle(true);

          unawaited(
            (ref.read(pWallets).getWallet(widget.walletId) as MwebInterface)
                .open(),
          );
        }
      } else {
        await _updateMwebToggle(false);
      }
    } finally {
      // ensure _switchMwebToggleToggledLock is set to false no matter what.
      _switchMwebToggleToggledLock = false;
    }
  }

  Future<void> _updateMwebToggle(bool value) async {
    await ref
        .read(pWalletInfo(widget.walletId))
        .updateOtherData(
          newEntries: {WalletInfoKeys.mwebEnabled: value},
          isar: ref.read(mainDBProvider).isar,
        );

    if (_switchControllerMwebToggle.isOn != null) {
      if (_switchControllerMwebToggle.isOn!.call() != value) {
        _switchControllerMwebToggle.activate?.call();
      }
    }
  }

  Future<void> _updateAddressReuse(bool shouldReuse) async {
    await ref
        .read(pWalletInfo(widget.walletId))
        .updateOtherData(
          newEntries: {WalletInfoKeys.reuseAddress: shouldReuse},
          isar: ref.read(mainDBProvider).isar,
        );

    if (_switchController.isOn != null) {
      if (_switchController.isOn!.call() != shouldReuse) {
        _switchController.activate?.call();
      }
    }
  }

  @override
  void initState() {
    _switchController = DSBController();
    _switchControllerMwebToggle = DSBController();
    super.initState();
  }

  @override
  Widget build(BuildContext context) {
    final wallet = ref.watch(pWallets).getWallet(widget.walletId);

    final isViewOnlyNoAddressGen =
        wallet is ViewOnlyOptionInterface &&
        wallet.isViewOnly &&
        wallet.viewOnlyType == ViewOnlyWalletType.addressOnly;

    return Background(
      child: Scaffold(
        backgroundColor: Theme.of(context).extension<StackColors>()!.background,
        appBar: AppBar(
          leading: AppBarBackButton(
            onPressed: () {
              Navigator.of(context).pop();
            },
          ),
          title: Text(
            "Wallet settings",
            style: STextStyles.navBarTitle(context),
          ),
        ),
        body: SafeArea(
          child: Padding(
            padding: const EdgeInsets.only(top: 12, left: 16, right: 16),
            child: SingleChildScrollView(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  RoundedWhiteContainer(
                    padding: const EdgeInsets.all(0),
                    child: RawMaterialButton(
                      // splashColor: Theme.of(context).extension<StackColors>()!.highlight,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(
                          Constants.size.circularBorderRadius,
                        ),
                      ),
                      materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                      onPressed: () {
                        Navigator.of(context).pushNamed(
                          RenameWalletView.routeName,
                          arguments: widget.walletId,
                        );
                      },
                      child: Padding(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 12.0,
                          vertical: 20,
                        ),
                        child: Row(
                          children: [
                            Text(
                              "Rename wallet",
                              style: STextStyles.titleBold12(context),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                  if (wallet is RbfInterface) const SizedBox(height: 8),
                  if (wallet is RbfInterface)
                    RoundedWhiteContainer(
                      padding: const EdgeInsets.all(0),
                      child: RawMaterialButton(
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(
                            Constants.size.circularBorderRadius,
                          ),
                        ),
                        materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        onPressed: () {
                          Navigator.of(context).pushNamed(
                            RbfSettingsView.routeName,
                            arguments: widget.walletId,
                          );
                        },
                        child: Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12.0,
                            vertical: 20,
                          ),
                          child: Row(
                            children: [
                              Text(
                                "RBF settings",
                                style: STextStyles.titleBold12(context),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  if (wallet is MultiAddressInterface &&
                      !isViewOnlyNoAddressGen)
                    const SizedBox(height: 8),
                  if (wallet is MultiAddressInterface &&
                      !isViewOnlyNoAddressGen)
                    RoundedWhiteContainer(
                      padding: const EdgeInsets.all(0),
                      child: RawMaterialButton(
                        // splashColor: Theme.of(context).extension<StackColors>()!.highlight,
                        materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(
                            Constants.size.circularBorderRadius,
                          ),
                        ),
                        onPressed: _switchReuseAddressToggled,
                        child: Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12.0,
                            vertical: 20,
                          ),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                "Reuse receiving address",
                                style: STextStyles.titleBold12(context),
                                textAlign: TextAlign.left,
                              ),
                              SizedBox(
                                height: 20,
                                width: 40,
                                child: IgnorePointer(
                                  child: DraggableSwitchButton(
                                    isOn:
                                        ref.watch(
                                              pWalletInfo(
                                                widget.walletId,
                                              ).select(
                                                (value) => value.otherData,
                                              ),
                                            )[WalletInfoKeys.reuseAddress]
                                            as bool? ??
                                        false,
                                    controller: _switchController,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  if (wallet is MwebInterface) const SizedBox(height: 8),
                  if (wallet is MwebInterface)
                    RoundedWhiteContainer(
                      padding: const EdgeInsets.all(0),
                      child: RawMaterialButton(
                        // splashColor: Theme.of(context).extension<StackColors>()!.highlight,
                        materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(
                            Constants.size.circularBorderRadius,
                          ),
                        ),
                        onPressed: _switchMwebToggleToggled,
                        child: Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12.0,
                            vertical: 20,
                          ),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                "Enable MWEB",
                                style: STextStyles.titleBold12(context),
                                textAlign: TextAlign.left,
                              ),
                              SizedBox(
                                height: 20,
                                width: 40,
                                child: IgnorePointer(
                                  child: DraggableSwitchButton(
                                    isOn:
                                        ref.watch(
                                              pWalletInfo(
                                                widget.walletId,
                                              ).select(
                                                (value) => value.otherData,
                                              ),
                                            )[WalletInfoKeys.mwebEnabled]
                                            as bool? ??
                                        false,
                                    controller: _switchControllerMwebToggle,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  if (!ref.watch(pDuress)) const SizedBox(height: 8),
                  if (!ref.watch(pDuress))
                    RoundedWhiteContainer(
                      padding: const EdgeInsets.all(0),
                      child: RawMaterialButton(
                        materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(
                            Constants.size.circularBorderRadius,
                          ),
                        ),
                        onPressed: _switchDuressToggled,
                        child: Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12.0,
                            vertical: 20,
                          ),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                "Show in duress",
                                style: STextStyles.titleBold12(context),
                                textAlign: TextAlign.left,
                              ),
                              SizedBox(
                                height: 20,
                                width: 40,
                                child: IgnorePointer(
                                  child: DraggableSwitch(
                                    value:
                                        ref.watch(
                                              pWalletInfo(
                                                widget.walletId,
                                              ).select(
                                                (value) => value.otherData,
                                              ),
                                            )[WalletInfoKeys
                                                .duressMarkedVisibleWalletKey]
                                            as bool? ??
                                        false,
                                    onChanged: (_) => (),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  if (wallet is SparkInterface && !wallet.isViewOnly)
                    const SizedBox(height: 8),
                  if (wallet is SparkInterface && !wallet.isViewOnly)
                    RoundedWhiteContainer(
                      padding: const EdgeInsets.all(0),
                      child: RawMaterialButton(
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(
                            Constants.size.circularBorderRadius,
                          ),
                        ),
                        materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        onPressed: () {
                          Navigator.of(context).pushNamed(
                            SparkInfoView.routeName,
                            arguments: widget.walletId,
                          );
                        },
                        child: Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12.0,
                            vertical: 20,
                          ),
                          child: Row(
                            children: [
                              Text(
                                "Spark info",
                                style: STextStyles.titleBold12(context),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  if (wallet is LibMoneroWallet || wallet is LibSalviumWallet)
                    const SizedBox(height: 8),
                  if (wallet is LibMoneroWallet || wallet is LibSalviumWallet)
                    RoundedWhiteContainer(
                      padding: const EdgeInsets.all(0),
                      child: RawMaterialButton(
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(
                            Constants.size.circularBorderRadius,
                          ),
                        ),
                        materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        onPressed: () {
                          Navigator.of(context).pushNamed(
                            EditRefreshHeightView.routeName,
                            arguments: widget.walletId,
                          );
                        },
                        child: Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12.0,
                            vertical: 20,
                          ),
                          child: Row(
                            children: [
                              Text(
                                "Restore height",
                                style: STextStyles.titleBold12(context),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  const SizedBox(height: 8),
                  RoundedWhiteContainer(
                    padding: const EdgeInsets.all(0),
                    child: RawMaterialButton(
                      // splashColor: Theme.of(context).extension<StackColors>()!.highlight,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(
                          Constants.size.circularBorderRadius,
                        ),
                      ),
                      materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                      padding: const EdgeInsets.all(0),
                      onPressed: () {
                        showDialog<void>(
                          barrierDismissible: true,
                          context: context,
                          builder:
                              (_) => StackDialog(
                                title:
                                    "Do you want to delete ${ref.read(pWalletName(widget.walletId))}?",
                                leftButton: TextButton(
                                  style: Theme.of(context)
                                      .extension<StackColors>()!
                                      .getSecondaryEnabledButtonStyle(context),
                                  onPressed: () {
                                    Navigator.pop(context);
                                  },
                                  child: Text(
                                    "Cancel",
                                    style: STextStyles.button(context).copyWith(
                                      color:
                                          Theme.of(context)
                                              .extension<StackColors>()!
                                              .accentColorDark,
                                    ),
                                  ),
                                ),
                                rightButton: TextButton(
                                  style: Theme.of(context)
                                      .extension<StackColors>()!
                                      .getPrimaryEnabledButtonStyle(context),
                                  onPressed: () {
                                    Navigator.pop(context);
                                    Navigator.push(
                                      context,
                                      RouteGenerator.getRoute(
                                        shouldUseMaterialRoute:
                                            RouteGenerator.useMaterialPageRoute,
                                        builder:
                                            (_) => LockscreenView(
                                              routeOnSuccessArguments:
                                                  widget.walletId,
                                              showBackButton: true,
                                              routeOnSuccess:
                                                  DeleteWalletWarningView
                                                      .routeName,
                                              biometricsCancelButtonString:
                                                  "CANCEL",
                                              biometricsLocalizedReason:
                                                  "Authenticate to delete wallet",
                                              biometricsAuthenticationTitle:
                                                  "Delete wallet",
                                            ),
                                        settings: const RouteSettings(
                                          name: "/deleteWalletLockscreen",
                                        ),
                                      ),
                                    );
                                  },
                                  child: Text(
                                    "Delete",
                                    style: STextStyles.button(context),
                                  ),
                                ),
                              ),
                        );
                      },
                      child: Padding(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 12.0,
                          vertical: 20,
                        ),
                        child: Row(
                          children: [
                            Text(
                              "Delete wallet",
                              style: STextStyles.titleBold12(context),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

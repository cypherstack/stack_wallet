/* 
 * This file is part of Stack Wallet.
 * 
 * Copyright (c) 2023 Cypher Stack
 * All Rights Reserved.
 * The code is distributed under GPLv3 license, see LICENSE file for details.
 * Generated by Cypher Stack on 2023-05-26
 *
 */

import 'dart:io';

import 'package:file_picker/file_picker.dart';
import 'package:flutter/material.dart';
import 'package:path_provider/path_provider.dart';
import 'package:permission_handler/permission_handler.dart';

import '../../../../../app_config.dart';
import '../../../../../utilities/util.dart';

class SWBFileSystem {
  Directory? rootPath;
  Directory? startPath;

  String? filePath;
  String? dirPath;

  final bool isDesktop = Util.isDesktop;

  Future<Directory> prepareStorage() async {
    if (Platform.isAndroid) {
      await Permission.storage.request();
    }
    rootPath = (await getApplicationDocumentsDirectory());
    //todo: check if print needed
    // debugPrint(rootPath!.absolute.toString());
    if (Platform.isAndroid) {
      rootPath = Directory("/storage/emulated/0/");
    }
    //todo: check if print needed
    // debugPrint(rootPath!.absolute.toString());

    late Directory sampleFolder;
    const dirName = "${AppConfig.prefix}_backup";

    if (Platform.isIOS) {
      sampleFolder = Directory(rootPath!.path);
    } else if (Platform.isAndroid) {
      sampleFolder = Directory('${rootPath!.path}Documents/$dirName');
    } else if (Platform.isLinux) {
      sampleFolder = Directory('${rootPath!.path}/$dirName');
    } else if (Platform.isWindows) {
      sampleFolder = Directory('${rootPath!.path}/$dirName');
    } else if (Platform.isMacOS) {
      sampleFolder = Directory('${rootPath!.path}/$dirName');
    }

    try {
      if (!sampleFolder.existsSync()) {
        sampleFolder.createSync(recursive: true);
      }
    } catch (e, s) {
      // todo: come back to this
      debugPrint("$e $s");
    }

    File sampleFile = File('${sampleFolder.path}/Backups_Go_Here.info');
    if (Platform.isIOS) {
      sampleFile = File('${rootPath!.path}/Backups_Go_Here.info');
    }

    try {
      if (!sampleFile.existsSync()) {
        sampleFile.createSync();
      }
    } catch (e, s) {
      // todo: come back to this
      debugPrint("$e $s");
    }
    startPath = sampleFolder;
    return sampleFolder;
  }

  Future<void> pickDir(BuildContext context) async {
    final String? chosenPath;
    if (Platform.isIOS) {
      chosenPath = startPath?.path;
    } else {
      final String path = Platform.isWindows
          ? startPath!.path.replaceAll("/", "\\")
          : startPath!.path;
      chosenPath = await FilePicker.platform.getDirectoryPath(
        dialogTitle: "Choose Backup location",
        initialDirectory: path,
        lockParentWindow: true,
      );
    }
    dirPath = chosenPath;
  }

  Future<void> openFile(BuildContext context) async {
    FilePickerResult? result;
    if (Platform.isAndroid) {
      result = await FilePicker.platform.pickFiles(
        dialogTitle: "Load backup file",
        initialDirectory: startPath!.path,
        type: FileType.any,
        allowCompression: false,
        lockParentWindow: true,
      );
    } else if (Platform.isIOS) {
      result = await FilePicker.platform.pickFiles(
        dialogTitle: "Load backup file",
        initialDirectory: startPath!.path,
        type: FileType.any,
        allowCompression: false,
        lockParentWindow: true,
      );
    } else {
      result = await FilePicker.platform.pickFiles(
        dialogTitle: "Load backup file",
        initialDirectory: startPath!.path,
        type: FileType.custom,
        allowedExtensions: ['bin', 'swb'],
        allowCompression: false,
        lockParentWindow: true,
      );
    }

    filePath = result?.paths.first;
  }
}
